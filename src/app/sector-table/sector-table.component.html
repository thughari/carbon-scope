<div class="table-card overflow-hidden">
  <div class="p-5 border-b border-slate-800/60 flex items-center justify-between">
    <p class="chart-title mb-0">Sector Details</p>
    <button (click)="downloadCSV()"
      class="text-xs font-medium text-sky-400 hover:text-sky-300 transition-colors flex items-center gap-1">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
      Export CSV
    </button>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="bg-slate-900/50 text-xs text-slate-400 uppercase tracking-wider font-semibold">
        <tr>
          <th class="px-5 py-3 text-left">Sector Name</th>

          <th class="hidden md:table-cell px-5 py-3 text-left">Description</th>

          <th class="px-5 py-3 text-right">Emissions (t)</th>

          <th class="hidden md:table-cell px-5 py-3 text-right">Action</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-800/60">

        <ng-container *ngFor="let kv of sectorTotals | keyvalue">

          <tr (click)="toggleRow(kv.key)" class="group cursor-pointer transition-colors duration-200"
            [ngClass]="expandedSector === kv.key ? 'bg-slate-800/40' : 'hover:bg-slate-800/40'">

            <td class="px-5 py-4 font-medium text-slate-200 group-hover:text-white flex items-center gap-3">
              <span class="w-2.5 h-2.5 rounded-full transition-all duration-300 shrink-0"
                [ngClass]="expandedSector === kv.key ? 'bg-sky-400 shadow-[0_0_8px_rgba(56,189,248,0.6)]' : 'bg-slate-700 group-hover:bg-sky-500'">
              </span>
              <span class="truncate">{{ kv.key }}</span>
              <svg *ngIf="expandedSector !== kv.key" class="md:hidden w-4 h-4 text-slate-600 ml-1" fill="none"
                stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
              <svg *ngIf="expandedSector === kv.key" class="md:hidden w-4 h-4 text-sky-400 ml-1" fill="none"
                stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
              </svg>
            </td>

            <td class="hidden md:table-cell px-5 py-4 text-slate-400 max-w-[200px] truncate">
              {{ sectorDescriptions[kv.key] || '--' }}
            </td>

            <td class="px-5 py-4 text-right text-slate-200 font-mono tracking-tight whitespace-nowrap">
              {{ kv.value | number:'1.0-0' }}
            </td>

            <td class="hidden md:table-cell px-5 py-4 text-right">
              <button class="badge transition-all duration-200" [ngClass]="expandedSector === kv.key 
                    ? 'bg-rose-500 text-white border-rose-500 hover:bg-rose-600 shadow-[0_0_10px_rgba(244,63,94,0.4)]' 
                    : 'text-slate-400 border-slate-700 hover:bg-sky-500 hover:text-white hover:border-sky-500'">
                {{ expandedSector === kv.key ? 'Close' : 'Details' }}
              </button>
            </td>
          </tr>

          <tr *ngIf="expandedSector === kv.key" class="bg-slate-900/30">
            <td colspan="4" class="px-0 py-0 border-b border-slate-800/60">

              <div class="animate-slide-down overflow-hidden">
                <div class="px-5 py-5 flex">

                  <div class="w-1 bg-sky-500 rounded-full mr-5 opacity-80 shrink-0"></div>

                  <div class="w-full">
                    <div *ngIf="isLoadingSubsectors" class="py-4 text-slate-400 text-xs flex items-center gap-2">
                      <svg class="animate-spin h-4 w-4 text-sky-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                      </svg>
                      Analysing breakdown...
                    </div>

                    <div *ngIf="!isLoadingSubsectors && subsectorData?.sector === kv.key">
                      <p class="md:hidden text-xs text-slate-500 mb-3 italic">
                        {{ sectorDescriptions[kv.key] }}
                      </p>

                      <p class="text-[11px] font-bold text-sky-400 mb-3 uppercase tracking-widest">
                        Breakdown: <span class="text-white">{{ kv.key }}</span>
                      </p>

                      <div class="grid gap-3 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                        <div *ngFor="let sub of subsectorData!.subsectorTotals | keyvalue" class="subsector-card group">

                          <span class="text-xs text-slate-200 font-medium truncate mr-2" [title]="sub.key">
                            {{ sub.key }}
                          </span>

                          <span
                            class="text-[11px] font-mono font-semibold text-slate-300 bg-slate-800 px-2 py-1 rounded-md border border-slate-700/50 group-hover:border-slate-600 group-hover:text-white transition-colors">
                            {{ sub.value | number:'1.0-0' }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>
</div>